name: Scheduled Maintenance

on:
    schedule:
        # Run every Monday at 09:00 UTC
        - cron: '0 9 * * 1'
    workflow_dispatch: # Allow manual triggering

jobs:
    dependency-update:
        name: Update Dependencies
        runs-on: ubuntu-latest
        steps:
            - name: ğŸ“‚ Checkout code
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: ğŸ¦€ Setup Rust
              uses: dtolnay/rust-toolchain@stable

            - name: ğŸ“¦ Cache dependencies
              uses: Swatinem/rust-cache@v2

            - name: ğŸ”„ Update Cargo.lock
              run: cargo update

            - name: ğŸ§ª Test with updated dependencies
              run: |
                  cargo check
                  cargo test
                  cargo clippy -- -D warnings

            - name: ğŸ“Š Check for outdated dependencies
              run: |
                  cargo install cargo-outdated
                  cargo outdated --depth 1 > outdated_deps.txt || true

            - name: ğŸ›¡ï¸ Security audit
              run: |
                  cargo install cargo-audit
                  cargo audit > security_audit.txt || true

            - name: ğŸ“ Create update report
              run: |
                  echo "# ğŸ”„ Weekly Dependency Update Report" > update_report.md
                  echo "" >> update_report.md
                  echo "## ğŸ“¦ Updated Dependencies" >> update_report.md
                  echo "\`\`\`" >> update_report.md
                  git diff Cargo.lock >> update_report.md || echo "No dependency updates available" >> update_report.md
                  echo "\`\`\`" >> update_report.md
                  echo "" >> update_report.md
                  echo "## ğŸ“Š Outdated Dependencies" >> update_report.md
                  echo "\`\`\`" >> update_report.md
                  cat outdated_deps.txt >> update_report.md
                  echo "\`\`\`" >> update_report.md
                  echo "" >> update_report.md
                  echo "## ğŸ›¡ï¸ Security Audit" >> update_report.md
                  echo "\`\`\`" >> update_report.md
                  cat security_audit.txt >> update_report.md
                  echo "\`\`\`" >> update_report.md

            - name: ğŸ” Check if there are changes
              id: changes
              run: |
                  if git diff --quiet Cargo.lock; then
                    echo "has_changes=false" >> $GITHUB_OUTPUT
                  else
                    echo "has_changes=true" >> $GITHUB_OUTPUT
                  fi

            - name: ğŸ“¤ Create Pull Request
              if: steps.changes.outputs.has_changes == 'true'
              uses: peter-evans/create-pull-request@v5
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  commit-message: 'ğŸ”„ chore: update dependencies'
                  title: 'ğŸ”„ Weekly Dependency Updates'
                  body-path: update_report.md
                  branch: automated/dependency-updates
                  delete-branch: true
                  labels: |
                      dependencies
                      automated
                      maintenance

    security-scan:
        name: Security Scan
        runs-on: ubuntu-latest
        steps:
            - name: ğŸ“‚ Checkout code
              uses: actions/checkout@v4

            - name: ğŸ›¡ï¸ Run Trivy vulnerability scanner
              uses: aquasecurity/trivy-action@master
              with:
                  scan-type: 'fs'
                  scan-ref: '.'
                  format: 'sarif'
                  output: 'trivy-results.sarif'

            - name: ğŸ“¤ Upload Trivy scan results to GitHub Security tab
              uses: github/codeql-action/upload-sarif@v2
              if: always()
              with:
                  sarif_file: 'trivy-results.sarif'
