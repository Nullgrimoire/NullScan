name: Scheduled Maintenance

on:
    schedule:
        # Run every Monday at 09:00 UTC
        - cron: '0 9 * * 1'
    workflow_dispatch: # Allow manual triggering

jobs:
    dependency-update:
        name: Update Dependencies
        runs-on: ubuntu-latest
        steps:
            - name: 📂 Checkout code
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: 🦀 Setup Rust
              uses: dtolnay/rust-toolchain@stable

            - name: 📦 Cache dependencies
              uses: Swatinem/rust-cache@v2

            - name: 🔄 Update Cargo.lock
              run: cargo update

            - name: 🧪 Test with updated dependencies
              run: |
                  cargo check
                  cargo test
                  cargo clippy -- -D warnings

            - name: 📊 Check for outdated dependencies
              run: |
                  cargo install cargo-outdated
                  cargo outdated --depth 1 > outdated_deps.txt || true

            - name: 🛡️ Security audit
              run: |
                  cargo install cargo-audit
                  cargo audit > security_audit.txt || true

            - name: 📝 Create update report
              run: |
                  echo "# 🔄 Weekly Dependency Update Report" > update_report.md
                  echo "" >> update_report.md
                  echo "## 📦 Updated Dependencies" >> update_report.md
                  echo "\`\`\`" >> update_report.md
                  git diff Cargo.lock >> update_report.md || echo "No dependency updates available" >> update_report.md
                  echo "\`\`\`" >> update_report.md
                  echo "" >> update_report.md
                  echo "## 📊 Outdated Dependencies" >> update_report.md
                  echo "\`\`\`" >> update_report.md
                  cat outdated_deps.txt >> update_report.md
                  echo "\`\`\`" >> update_report.md
                  echo "" >> update_report.md
                  echo "## 🛡️ Security Audit" >> update_report.md
                  echo "\`\`\`" >> update_report.md
                  cat security_audit.txt >> update_report.md
                  echo "\`\`\`" >> update_report.md

            - name: 🔍 Check if there are changes
              id: changes
              run: |
                  if git diff --quiet Cargo.lock; then
                    echo "has_changes=false" >> $GITHUB_OUTPUT
                  else
                    echo "has_changes=true" >> $GITHUB_OUTPUT
                  fi

            - name: 📤 Create Pull Request
              if: steps.changes.outputs.has_changes == 'true'
              uses: peter-evans/create-pull-request@v5
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  commit-message: '🔄 chore: update dependencies'
                  title: '🔄 Weekly Dependency Updates'
                  body-path: update_report.md
                  branch: automated/dependency-updates
                  delete-branch: true
                  labels: |
                      dependencies
                      automated
                      maintenance

    security-scan:
        name: Security Scan
        runs-on: ubuntu-latest
        steps:
            - name: 📂 Checkout code
              uses: actions/checkout@v4

            - name: 🛡️ Run Trivy vulnerability scanner
              uses: aquasecurity/trivy-action@master
              with:
                  scan-type: 'fs'
                  scan-ref: '.'
                  format: 'sarif'
                  output: 'trivy-results.sarif'

            - name: 📤 Upload Trivy scan results to GitHub Security tab
              uses: github/codeql-action/upload-sarif@v2
              if: always()
              with:
                  sarif_file: 'trivy-results.sarif'
